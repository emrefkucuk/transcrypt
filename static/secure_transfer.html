<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure File Transfer System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        :root {
            /* Light mode variables */
            --background-color: #f8f9fa;
            --text-color: #212529;
            --card-bg: #ffffff;
            --card-header-bg: #007bff;
            --card-header-text: white;
            --card-border: none;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #198754;
            --danger-color: #dc3545;
            --warning-color: #fd7e14;
            --info-color: #0dcaf0;
            --border-color: #dee2e6;
            --input-bg: #fff;
            --input-text: #212529;
            --input-border: #ced4da;
            --secret-key-bg: #f1f1f1;
            --log-container-bg: #f8f9fa;
            --log-entry-border: #eee;
            --log-info-color: #0d6efd;
            --log-success-color: #198754;
            --log-error-color: #dc3545;
            --log-warning-color: #fd7e14;
            --file-info-bg: #e9ecef;
            --room-info-bg: #e9ecef;
            --textarea-bg: #ffffff;
        }

        [data-bs-theme="dark"] {
            /* Dark mode variables */
            --background-color: #212529;
            --text-color: #e9ecef;
            --card-bg: #343a40;
            --card-header-bg: #0d6efd;
            --card-header-text: white;
            --card-border: none;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            --primary-color: #0d6efd;
            --secondary-color: #6c757d;
            --success-color: #198754;
            --danger-color: #dc3545;
            --warning-color: #fd7e14;
            --info-color: #0dcaf0;
            --border-color: #495057;
            --input-bg: #2b3035;
            --input-text: #e9ecef;
            --input-border: #495057;
            --secret-key-bg: #343a40;
            --log-container-bg: #2b3035;
            --log-entry-border: #495057;
            --log-info-color: #0d6efd;
            --log-success-color: #20c997;
            --log-error-color: #dc3545;
            --log-warning-color: #fd7e14;
            --file-info-bg: #2b3035;
            --room-info-bg: #2b3035;
            --textarea-bg: #2b3035;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 900px;
            margin: 40px auto;
            padding: 0 15px;
        }

        .card {
            border-radius: 10px;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
            border: var(--card-border);
            background-color: var(--card-bg);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .card-header {
            background-color: var(--card-header-bg);
            color: var(--card-header-text);
            border-radius: 10px 10px 0 0 !important;
            font-weight: bold;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        .tab-content {
            padding: 20px;
        }

        .nav-tabs .nav-link.active {
            font-weight: bold;
            color: var(--primary-color);
        }

        .form-check-input:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        input, select, textarea {
            background-color: var(--input-bg) !important;
            color: var(--input-text) !important;
            border-color: var(--input-border) !important;
        }

        .secret-key {
            font-family: monospace;
            background: var(--secret-key-bg);
            color: var(--text-color);
            padding: 8px;
            border-radius: 4px;
            word-break: break-all;
        }

        .option-card {
            cursor: pointer;
            transition: all 0.3s;
            height: 100%;
        }

        .option-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .option-card.selected {
            border-color: var(--primary-color);
            border-width: 2px;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }

        .generating-indicator {
            display: none;
        }

        .generating-indicator.show {
            display: flex;
            align-items: center;
        }

        .spinner-border {
            margin-right: 10px;
        }

        .progress {
            height: 25px;
        }

        .log-container {
            max-height: 200px;
            overflow-y: auto;
            background-color: var(--log-container-bg);
            padding: 10px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            font-family: monospace;
            font-size: 0.9rem;
        }

        .log-entry {
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--log-entry-border);
        }

        .log-entry.info { color: var(--log-info-color); }
        .log-entry.success { color: var(--log-success-color); }
        .log-entry.error { color: var(--log-error-color); }
        .log-entry.warning { color: var(--log-warning-color); }

        .file-info {
            background-color: var(--file-info-bg);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        #stegoPrompt, #regeneratePrompt {
            resize: vertical;
            min-height: 100px;
            background-color: var(--textarea-bg);
            color: var(--text-color);
        }

        #stegoMessage, #encryptedMessage {
            resize: vertical;
            min-height: 150px;
            background-color: var(--textarea-bg);
            color: var(--text-color);
        }

        .room-info {
            background-color: var(--room-info-bg);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .integrity-result {
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }

        .integrity-success {
            background-color: rgba(25, 135, 84, 0.2);
            color: var(--success-color);
            border: 1px solid rgba(25, 135, 84, 0.4);
        }

        .integrity-error {
            background-color: rgba(220, 53, 69, 0.2);
            color: var(--danger-color);
            border: 1px solid rgba(220, 53, 69, 0.4);
        }

        .stego-image-container {
            text-align: center;
            margin-bottom: 15px;
        }

        .stego-image-container img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .info-text {
            color: var(--secondary-color);
            font-size: 0.9rem;
            margin-top: 8px;
        }

        /* Theme toggle button */
        .theme-toggle {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 1000;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
        }
        
        .theme-toggle:hover {
            transform: scale(1.1);
        }
        
        .theme-toggle i {
            font-size: 1.2rem;
            color: var(--text-color);
        }

        /* Mobile responsiveness improvements */
        @media (max-width: 768px) {
            .container {
                margin: 20px auto;
                padding: 0 10px;
            }
            
            .card {
                margin-bottom: 15px;
            }
            
            h1 {
                font-size: 1.8rem;
                margin-bottom: 1rem !important;
            }
            
            h5 {
                font-size: 1.1rem;
            }
            
            .btn {
                padding: 0.375rem 0.5rem;
            }
            
            .theme-toggle {
                top: 10px;
                right: 10px;
                width: 35px;
                height: 35px;
            }
            
            .d-flex.gap-2 {
                flex-wrap: wrap;
            }
            
            .d-flex.gap-2 button {
                flex: 1 0 auto;
                margin-bottom: 5px;
            }
        }

        /* Additional mobile improvements for small screens */
        @media (max-width: 576px) {
            .card-header {
                padding: 0.75rem;
            }
            
            .card-body {
                padding: 0.75rem;
            }
            
            .tab-content {
                padding: 10px;
            }
            
            .btn {
                width: 100%;
                margin-bottom: 5px;
            }
            
            .d-flex.justify-content-between {
                flex-direction: column;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <!-- Theme Toggle Button -->
    <div class="theme-toggle" id="themeToggle" title="Change Theme">
        <i class="bi bi-moon-fill"></i>
    </div>
    
    <div class="container">
        <h1 class="text-center mb-4">Secure File Transfer</h1>

        <!-- Initial Options Section -->
        <div id="initialOptions" class="card">
            <div class="card-header">
                <h5 class="mb-0">Choose an operation</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="card option-card" id="createRoomCard" onclick="showCreateRoomOptions()">
                            <div class="card-body text-center py-4">
                                <i class="bi bi-plus-circle fs-1 text-primary mb-3"></i>
                                <h5>Create New Room</h5>
                                <p class="text-muted">Create a new room for secure file transfer</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card option-card" id="joinRoomCard" onclick="showJoinRoomOptions()">
                            <div class="card-body text-center py-4">
                                <i class="bi bi-door-open fs-1 text-primary mb-3"></i>
                                <h5>Join a Room</h5>
                                <p class="text-muted">Join an existing room</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Room Options -->
        <div id="createRoomOptions" class="card" style="display: none;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Room Creation Options</h5>
                <button class="btn btn-sm btn-outline-light" onclick="goBack()">
                    <i class="bi bi-arrow-left"></i> Back
                </button>
            </div>
            <div class="card-body">
                <p>How should the secret key be shared?</p>
                
                <div class="row mb-4">
                    <div class="col-md-3 mb-3">
                        <div class="card option-card" onclick="selectKeyOption('direct')">
                            <div class="card-body p-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="keyOption" id="directOption" value="direct">
                                    <label class="form-check-label w-100" for="directOption">
                                        <div class="d-flex align-items-center mb-2">
                                            <i class="bi bi-key fs-2 text-primary me-2"></i>
                                            <h5 class="mb-0">Direct</h5>
                                        </div>
                                        <p class="text-muted mb-0">Secret key will be shared as simple plaintext</p>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card option-card" onclick="selectKeyOption('stego')">
                            <div class="card-body p-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="keyOption" id="stegoOption" value="stego">
                                    <label class="form-check-label w-100" for="stegoOption">
                                        <div class="d-flex align-items-center mb-2">
                                            <i class="bi bi-file-earmark-lock fs-2 text-primary me-2"></i>
                                            <h5 class="mb-0">Hide in Text</h5>
                                        </div>
                                        <p class="text-muted mb-0">Secret key will be hidden in text</p>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card option-card" onclick="selectKeyOption('image')">
                            <div class="card-body p-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="keyOption" id="imageOption" value="image">
                                    <label class="form-check-label w-100" for="imageOption">
                                        <div class="d-flex align-items-center mb-2">
                                            <i class="bi bi-image-fill fs-2 text-primary me-2"></i>
                                            <h5 class="mb-0">Hide in Image</h5>
                                        </div>
                                        <p class="text-muted mb-0">Secret key will be hidden in an image (LSB)</p>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card option-card" onclick="selectKeyOption('email')">
                            <div class="card-body p-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="keyOption" id="emailOption" value="email">
                                    <label class="form-check-label w-100" for="emailOption">
                                        <div class="d-flex align-items-center mb-2">
                                            <i class="bi bi-envelope-fill fs-2 text-primary me-2"></i>
                                            <h5 class="mb-0">Hide in Mail</h5>
                                        </div>
                                        <p class="text-muted mb-0">Connection link will be in an e-mail</p>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Steganography Prompt with Model Selection (Hidden by Default) -->
                <div id="stegoPromptContainer" class="mb-4" style="display: none;">
                    <div class="row">
                        <div class="col-md-8">
                            <label for="stegoPrompt" class="form-label">Topic to be used in prompt (optional):</label>
                            <textarea class="form-control" id="stegoPrompt" rows="3" placeholder="Example: 'Write a message about secure file transfer'"></textarea>
                            <div class="form-text">Secret key will be hidden in a natural message that will be written according to the topic.</div>
                        </div>
                        <div class="col-md-4">
                            <label for="modelSelect" class="form-label">AI Model:</label>
                            <select class="form-select" id="modelSelect">
                                <option value="facebook/opt-1.3b">Meta OPT (1.3B)</option>
                                <option value="EleutherAI/pythia-1b">Pythia (1B)</option>
                                <option value="microsoft/phi-1_5">Microsoft Phi-1.5</option>
                                <option value="gpt2">OpenAI GPT-2</option>
                            </select>
                            <div class="form-text">Language model to be used</div>
                        </div>
                    </div>
                </div>

                <!-- Image Upload (Hidden by Default) -->
                <div id="imageUploadContainer" class="mb-4" style="display: none;">
                    <label for="stegoImage" class="form-label">Choose image to hide secret key in:</label>
                    <input class="form-control" type="file" id="stegoImage" accept="image/*">
                    <div class="form-text">
                        Supported formats: PNG, JPG, JPEG, BMP, TIFF, WEBP<br>
                        Secret key will be hidden in image using the LSB (Least Significant Bits) method.
                    </div>
                </div>

                <!-- Email Setup (Hidden by Default) -->
                <div id="emailSetupContainer" class="mb-4" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">E-mail Information</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="senderEmail" class="form-label">Sender E-mail Address:</label>
                                <input type="email" class="form-control" id="senderEmail" placeholder="example@gmail.com">
                                <div class="form-text">Gmail account recommended</div>
                            </div>
                            <div class="mb-3">
                                <label for="appPassword" class="form-label">App Password:</label>
                                <input type="password" class="form-control" id="appPassword">
                                <div class="form-text">
                                    Create an <a href="https://myaccount.google.com/apppasswords" target="_blank">app password</a> for transfer
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="receiverEmail" class="form-label">Receiver E-mail Address:</label>
                                <input type="email" class="form-control" id="receiverEmail" placeholder="receiver@example.com">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="generating-indicator mb-3" id="generatingIndicator">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span>Creating room, please wait...</span>
                </div>

                <!-- Maximum receivers setting -->
                <div class="mb-3">
                    <label for="maxReceivers" class="form-label">Maximum Receiver Amount:</label>
                    <div class="input-group">
                        <input type="number" class="form-control" id="maxReceivers" min="0" value="0">
                        <span class="input-group-text">people</span>
                    </div>
                    <div class="form-text">Maximum people in the room (0 = unlimited)</div>
                </div>

                <div class="d-grid">
                    <button class="btn btn-primary" id="createRoomBtn" onclick="createRoom()">Create Room</button>
                </div>
            </div>
        </div>

        <!-- Join Room Options -->
        <div id="joinRoomOptions" class="card" style="display: none;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Join Room</h5>
                <button class="btn btn-sm btn-outline-light" onclick="goBack()">
                    <i class="bi bi-arrow-left"></i> Back
                </button>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs" id="joinTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="direct-tab" data-bs-toggle="tab" data-bs-target="#direct" type="button" role="tab">Enter Secret Key</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="encrypted-tab" data-bs-toggle="tab" data-bs-target="#encrypted" type="button" role="tab">Enter Hidden Message</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="image-tab" data-bs-toggle="tab" data-bs-target="#image" type="button" role="tab">Upload Image</button>
                    </li>
                </ul>
                <div class="tab-content" id="joinTabsContent">
                    <div class="tab-pane fade show active" id="direct" role="tabpanel">
                        <div class="mb-3">
                            <label for="secretKey" class="form-label">Secret Key</label>
                            <input type="text" class="form-control" id="secretKey" placeholder="Enter secret key here">
                        </div>
                        <div class="d-grid">
                            <button class="btn btn-primary" onclick="joinRoomWithKey()">Join Room</button>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="encrypted" role="tabpanel">
                        <div class="mb-3">
                            <label for="encryptedMessage" class="form-label">Steganographic Message</label>
                            <textarea class="form-control" id="encryptedMessage" placeholder="Paste message here"></textarea>
                            <div class="form-text">Secret key will be extracted from the message and the room will be joined automatically.</div>
                        </div>
                        <div class="d-grid">
                            <button class="btn btn-primary" onclick="extractKeyAndJoin()">Extract Secret Key and Join</button>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="image" role="tabpanel">
                        <div class="mb-3">
                            <label for="stegoImageUpload" class="form-label">Steganographic Image</label>
                            <input class="form-control" type="file" id="stegoImageUpload" accept="image/*">
                            <div class="form-text">Secret key will be extracted from the image and the room will be joined automatically.</div>
                        </div>
                        <div class="d-grid">
                            <button class="btn btn-primary" onclick="extractKeyFromImageAndJoin()">Extract Secret Key and Join</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Room Created with Direct Key -->
        <div id="roomCreatedDirect" class="card" style="display: none;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Room Created</h5>
                <button class="btn btn-sm btn-outline-light" onclick="goBack()">
                    <i class="bi bi-arrow-left"></i> Back
                </button>
            </div>
            <div class="card-body">
                <p>Secret Key created. Share it with the receiver:</p>
                <div class="secret-key mb-3" id="generatedKey"></div>
                <div class="d-flex gap-2 mb-4">
                    <button class="btn btn-secondary" onclick="copyToClipboard('generatedKey')">
                        <i class="bi bi-clipboard"></i> Copy
                    </button>
                    <button class="btn btn-primary" onclick="continueAsSender()">
                        <i class="bi bi-send"></i> Continue as Sender
                    </button>
                </div>
            </div>
        </div>

        <!-- Room Created with Steganographic Key -->
        <div id="roomCreatedStego" class="card" style="display: none;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Room Created With Secret Key</h5>
                <button class="btn btn-sm btn-outline-light" onclick="goBack()">
                    <i class="bi bi-arrow-left"></i> Geri
                </button>
            </div>
            <div class="card-body">
                <p>Share the message below with the receiver. Secret key is hidden inside:</p>
                <div class="mb-3">
                    <label for="stegoMessage" class="form-label">Message With Secret Key:</label>
                    <textarea class="form-control" id="stegoMessage" readonly></textarea>
                </div>
                <div class="d-flex gap-2 mb-4">
                    <button class="btn btn-secondary" onclick="copyToClipboard('stegoMessage')">
                        <i class="bi bi-clipboard"></i> Copy Message
                    </button>
                    <button class="btn btn-primary" onclick="continueAsSender()">
                        <i class="bi bi-send"></i> Continue As Sender
                    </button>
                </div>
                
                <hr>
                
                <div class="mt-3">
                    <h6>Recreate Message</h6>
                    <p class="text-muted">Create another message for the same secret key:</p>
                    
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label for="regeneratePrompt" class="form-label">New Message Topic:</label>
                            <textarea class="form-control" id="regeneratePrompt" rows="2" placeholder="Different topic for new hidden message"></textarea>
                        </div>
                        <div class="col-md-4">
                            <label for="regenerateModel" class="form-label">AI Model:</label>
                            <select class="form-select" id="regenerateModel">
                                <option value="facebook/opt-1.3b">Meta OPT (1.3B)</option>
                                <option value="EleutherAI/pythia-1b">Pythia (1B)</option>
                                <option value="microsoft/phi-1_5">Microsoft Phi-1.5</option>
                                <option value="gpt2">OpenAI GPT-2</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="d-grid">
                        <button class="btn btn-outline-primary" id="regenerateBtn" onclick="regenerateStegoText()">
                            <i class="bi bi-arrow-repeat"></i> Recreate Text
                        </button>
                    </div>
                    
                    <div class="generating-indicator mt-3" id="regeneratingIndicator">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <span>New text generating, please wait...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Room Created with Image Steganography -->
        <div id="roomCreatedImage" class="card" style="display: none;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Room Created With Steganographic Image</h5>
                <button class="btn btn-sm btn-outline-light" onclick="goBack()">
                    <i class="bi bi-arrow-left"></i> Back
                </button>
            </div>
            <div class="card-body">
                <p>Secret key successfully hidden. Share it with the receiver:</p>
                
                <div class="stego-image-container">
                    <img id="stegoImagePreview" src="" alt="Steganographic Image">
                </div>
                
                <div class="d-flex gap-2 mb-4">
                    <button class="btn btn-secondary" onclick="downloadStegoImage()">
                        <i class="bi bi-download"></i> Download Image
                    </button>
                    <button class="btn btn-primary" onclick="continueAsSender()">
                        <i class="bi bi-send"></i> Continue as Sender
                    </button>
                </div>
                
                <div class="info-text">
                    <i class="bi bi-info-circle"></i> This image has the room's secret key hidden inside.
                    Receiver will automatically join the room after uploading this image.
                </div>
            </div>
        </div>
        
        <!-- Room Created with Email -->
        <div id="roomCreatedEmail" class="card" style="display: none;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Room Created With E-mail</h5>
                <button class="btn btn-sm btn-outline-light" onclick="goBack()">
                    <i class="bi bi-arrow-left"></i> Back
                </button>
            </div>
            <div class="card-body">
                <div class="alert alert-success">
                    <i class="bi bi-check-circle-fill me-2"></i> Connection link sent successfully via e-mail!
                </div>
                
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">E-mail Details</h6>
                    </div>
                    <div class="card-body">
                        <p><strong>Sender:</strong> <span id="emailSenderInfo"></span></p>
                        <p><strong>Receiver:</strong> <span id="emailReceiverInfo"></span></p>
                        <p><strong>Connection Linki:</strong> <span id="emailLinkInfo" class="text-primary"></span></p>
                    </div>
                </div>
                
                <div class="d-grid">
                    <button class="btn btn-primary" onclick="continueAsSender()">
                        <i class="bi bi-send"></i> Continue As Sender
                    </button>
                </div>
                
                <div class="mt-3 info-text">
                    <i class="bi bi-info-circle"></i> Receiver can join the room by clicking the connection link in e-mail.
                </div>
            </div>
        </div>

        <!-- File Transfer Interface -->
        <div id="fileTransfer" class="card" style="display: none;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">File Transfer</h5>
                <button class="btn btn-sm btn-outline-light" onclick="leaveRoom()">
                    <i class="bi bi-box-arrow-right"></i> Leave Room
                </button>
            </div>
            <div class="card-body">
                <div class="room-info">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Connection Status:</strong> <span id="connectionStatus">Connecting...</span></p>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex justify-content-between">
                                <p><strong>Sender:</strong> <span id="senderCount">0</span></p>
                                <p><strong>Receiver:</strong> <span id="receiverCount">0</span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sender Interface -->
                <div id="senderInterface" style="display: none;">
                    <h5 class="mb-3">Send File</h5>
                    <div class="mb-3">
                        <label for="fileInput" class="form-label">Choose file to send:</label>
                        <input class="form-control" type="file" id="fileInput">
                    </div>
                    
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0">Encryption Options</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="encryptionMethod" class="form-label">Encryption Metodu:</label>
                                <select class="form-select" id="encryptionMethod">
                                    <option value="aes-256-gcm">AES-256-GCM (Default)</option>
                                    <option value="none">No Encryption</option>
                                </select>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="" id="integrityCheck" checked>
                                <label class="form-check-label" for="integrityCheck">
                                    Integrity Validation (SHA-256)
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid">
                        <button class="btn btn-primary" id="sendFileBtn" onclick="sendFile()" disabled>
                            <i class="bi bi-upload"></i> Send File
                        </button>
                    </div>
                </div>

                <!-- Receiver Interface -->
                <div id="receiverInterface" style="display: none;">
                    <h5 class="mb-3">Receive File</h5>
                    <div class="alert alert-info" role="alert">
                        <i class="bi bi-info-circle-fill"></i> Waiting for a sender...
                    </div>
                    
                    <div id="encryptionInfo" class="card mb-3" style="display: none;">
                        <div class="card-header">
                            <h6 class="mb-0">Encryption Information</h6>
                        </div>
                        <div class="card-body">
                            <p id="encryptionMethodInfo">Encryption: Awaiting information...</p>
                            <p id="integrityCheckInfo">Integrity Validation: Awaiting information...</p>
                        </div>
                    </div>
                </div>

                <!-- Progress Section (Both Sender and Receiver) -->
                <div id="transferProgress" style="display: none;">
                    <h5 class="mt-4 mb-3">Transfer Progress</h5>
                    <div class="file-info" id="fileInfo">
                        Loading file information...
                    </div>
                    <div class="progress mb-3">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" id="progressBar" role="progressbar" style="width: 0%">0%</div>
                    </div>
                    
                    <div class="log-container mb-4" id="transferLogs">
                        <div class="log-entry info">Starting transfer...</div>
                    </div>
                    
                    <div class="integrity-result" id="integrityResult">
                        <div id="integrityMessage"></div>
                    </div>
                    
                    <div class="d-grid" id="downloadBtnContainer" style="display: none;">
                        <button class="btn btn-success" id="downloadBtn" onclick="downloadFile()">
                            <i class="bi bi-download"></i> Download File
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let currentSecretKey = null;
        let currentRole = null; // 'sender' or 'receiver'
        let wsConnection = null;
        let selectedFile = null;
        let receivedFileData = null;
        let receivedFileName = null;
        let receivedFileBlob = null;
        let receivedChunks = [];
        let totalChunks = 0;
        let encryptionMetadata = null;  // Store encryption metadata for decryption
        let stegoImageFilename = null;  // Store filename for stego image

        // Check if URL has key parameter on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Parse URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const keyParam = urlParams.get('key');
            
            // If key parameter exists, automatically join the room
            if (keyParam) {
                console.log('Key parameter detected:', keyParam);
                autoJoinWithKey(keyParam);
            }
        });

        // Function to automatically join room with key from URL
        async function autoJoinWithKey(secretKey) {
            if (!secretKey) return;
            
            try {
                const response = await fetch(`/api/check-room?secret_key=${encodeURIComponent(secretKey)}`);
                const data = await response.json();
                
                if (data.valid) {
                    currentSecretKey = secretKey;
                    setupAsReceiver();
                } else {
                    alert('Invalid secret key or nonexistent room.');
                }
            } catch (error) {
                console.error('Error joining room:', error);
                alert('An error occured while joining room.');
            }
        }

        // Show different sections of the interface
        function showCreateRoomOptions() {
            document.getElementById('initialOptions').style.display = 'none';
            document.getElementById('createRoomOptions').style.display = 'block';
        }

        function showJoinRoomOptions() {
            document.getElementById('initialOptions').style.display = 'none';
            document.getElementById('joinRoomOptions').style.display = 'block';
        }

        function goBack() {
            // Hide all cards except initial options
            document.getElementById('createRoomOptions').style.display = 'none';
            document.getElementById('joinRoomOptions').style.display = 'none';
            document.getElementById('roomCreatedDirect').style.display = 'none';
            document.getElementById('roomCreatedStego').style.display = 'none';
            document.getElementById('roomCreatedImage').style.display = 'none';
            document.getElementById('roomCreatedEmail').style.display = 'none';
            document.getElementById('fileTransfer').style.display = 'none';
            
            // Show initial options
            document.getElementById('initialOptions').style.display = 'block';
            
            // Reset WebSocket if needed
            if (wsConnection) {
                wsConnection.close();
                wsConnection = null;
            }
        }

        // Handle key sharing option selection
        function selectKeyOption(option) {
            // Update radio buttons
            document.getElementById('directOption').checked = (option === 'direct');
            document.getElementById('stegoOption').checked = (option === 'stego');
            document.getElementById('imageOption').checked = (option === 'image');
            document.getElementById('emailOption').checked = (option === 'email');
            
            // Style selected cards
            document.querySelectorAll('.option-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Show/hide appropriate containers
            document.getElementById('stegoPromptContainer').style.display = 'none';
            document.getElementById('imageUploadContainer').style.display = 'none';
            document.getElementById('emailSetupContainer').style.display = 'none';
            
            if (option === 'direct') {
                document.querySelector('.card.option-card[onclick="selectKeyOption(\'direct\')"]').classList.add('selected');
            } else if (option === 'stego') {
                document.querySelector('.card.option-card[onclick="selectKeyOption(\'stego\')"]').classList.add('selected');
                document.getElementById('stegoPromptContainer').style.display = 'block';
            } else if (option === 'image') {
                document.querySelector('.card.option-card[onclick="selectKeyOption(\'image\')"]').classList.add('selected');
                document.getElementById('imageUploadContainer').style.display = 'block';
            } else if (option === 'email') {
                document.querySelector('.card.option-card[onclick="selectKeyOption(\'email\')"]').classList.add('selected');
                document.getElementById('emailSetupContainer').style.display = 'block';
            }
        }

        // Create room function
        async function createRoom() {
            const useSteganography = document.getElementById('stegoOption').checked;
            const useImageSteganography = document.getElementById('imageOption').checked;
            const useEmail = document.getElementById('emailOption').checked;
            
            // Get maximum receivers setting
            const maxReceivers = document.getElementById('maxReceivers').value;
            
            try {
                // Show loading indicator
                document.getElementById('generatingIndicator').classList.add('show');
                document.getElementById('createRoomBtn').disabled = true;
                
                if (useImageSteganography) {
                    // Get the selected image file
                    const imageInput = document.getElementById('stegoImage');
                    const imageFile = imageInput.files[0];
                    
                    if (!imageFile) {
                        alert('Please choose an image');
                        document.getElementById('generatingIndicator').classList.remove('show');
                        document.getElementById('createRoomBtn').disabled = false;
                        return;
                    }
                    
                    // Check if the file is an image
                    if (!imageFile.type.startsWith('image/')) {
                        alert('Please choose a valid image!');
                        document.getElementById('generatingIndicator').classList.remove('show');
                        document.getElementById('createRoomBtn').disabled = false;
                        return;
                    }
                    
                    // Create FormData to send the image
                    const formData = new FormData();
                    formData.append('image', imageFile);
                    formData.append('max_receivers', maxReceivers);
                    
                    // Create image stego room
                    const response = await fetch('/api/create-image-stego-room', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    // Hide loading indicator
                    document.getElementById('generatingIndicator').classList.remove('show');
                    document.getElementById('createRoomBtn').disabled = false;
                    
                    if (data.status === 'success') {
                        currentSecretKey = data.secret_key;
                        stegoImageFilename = data.stego_image;
                        
                        // Load the steganographic image preview
                        document.getElementById('stegoImagePreview').src = `/api/download-stego-image/${stegoImageFilename}`;
                        
                        // Show image stego room created view
                        document.getElementById('createRoomOptions').style.display = 'none';
                        document.getElementById('roomCreatedImage').style.display = 'block';
                    } else {
                        alert('Room creation failed: ' + data.message);
                    }
                } else if (useSteganography) {
                    // Get prompt if provided
                    const prompt = document.getElementById('stegoPrompt').value.trim();
                    const model = document.getElementById('modelSelect').value;
                    
                    // Create steganographic room
                    const response = await fetch('/api/create-steganographic-room', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            prompt: prompt || undefined,
                            model: model,
                            max_receivers: parseInt(maxReceivers)
                        })
                    });
                    
                    const data = await response.json();
                    
                    // Hide loading indicator
                    document.getElementById('generatingIndicator').classList.remove('show');
                    document.getElementById('createRoomBtn').disabled = false;
                    
                    if (data.status === 'success') {
                        currentSecretKey = data.secret_key;
                        document.getElementById('stegoMessage').value = data.invitation_text;
                        
                        // Show stego room created view
                        document.getElementById('createRoomOptions').style.display = 'none';
                        document.getElementById('roomCreatedStego').style.display = 'block';
                    } else {
                        alert('Room creation failed: ' + data.message);
                    }
                } else if (useEmail) {
                    // Get email details
                    const senderEmail = document.getElementById('senderEmail').value.trim();
                    const appPassword = document.getElementById('appPassword').value.trim();
                    const receiverEmail = document.getElementById('receiverEmail').value.trim();
                    
                    if (!senderEmail || !appPassword || !receiverEmail) {
                        alert('Please fill all fields.');
                        document.getElementById('generatingIndicator').classList.remove('show');
                        document.getElementById('createRoomBtn').disabled = false;
                        return;
                    }
                    
                    // Create email room
                    const response = await fetch('/api/create-email-room', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            sender_email: senderEmail,
                            sender_password: appPassword,
                            recipient_email: receiverEmail,
                            max_receivers: parseInt(maxReceivers)
                        })
                    });
                    
                    const data = await response.json();
                    
                    // Hide loading indicator
                    document.getElementById('generatingIndicator').classList.remove('show');
                    document.getElementById('createRoomBtn').disabled = false;
                    
                    if (data.status === 'success') {
                        currentSecretKey = data.secret_key;
                        document.getElementById('emailSenderInfo').textContent = senderEmail;
                        document.getElementById('emailReceiverInfo').textContent = receiverEmail;
                        document.getElementById('emailLinkInfo').textContent = data.secure_link || data.invitation_link || '';
                        
                        // Show email room created view
                        document.getElementById('createRoomOptions').style.display = 'none';
                        document.getElementById('roomCreatedEmail').style.display = 'block';
                    } else {
                        alert('Room creation failed: ' + data.message);
                    }
                } else {
                    // Create direct key room
                    const response = await fetch('/api/create-room', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            max_receivers: parseInt(maxReceivers)
                        })
                    });
                    
                    const data = await response.json();
                    
                    // Hide loading indicator
                    document.getElementById('generatingIndicator').classList.remove('show');
                    document.getElementById('createRoomBtn').disabled = false;
                    
                    if (data.status === 'success') {
                        currentSecretKey = data.secret_key;
                        document.getElementById('generatedKey').textContent = data.secret_key;
                        
                        // Show direct room created view
                        document.getElementById('createRoomOptions').style.display = 'none';
                        document.getElementById('roomCreatedDirect').style.display = 'block';
                    } else {
                        alert('Room creation failed: ' + data.message);
                    }
                }
            } catch (error) {
                console.error('Error creating room:', error);
                document.getElementById('generatingIndicator').classList.remove('show');
                document.getElementById('createRoomBtn').disabled = false;
                alert('An error occured during room creation.');
            }
        }

        // Join room with secret key
        async function joinRoomWithKey() {
            const secretKey = document.getElementById('secretKey').value.trim();
            
            if (!secretKey) {
                alert('Please enter a Secret Key');
                return;
            }
            
            try {
                const response = await fetch(`/api/check-room?secret_key=${encodeURIComponent(secretKey)}`);
                const data = await response.json();
                
                if (data.valid) {
                    currentSecretKey = secretKey;
                    setupAsReceiver();
                } else {
                    alert('Invalid secret key or nonexistent room.');
                }
            } catch (error) {
                console.error('Error joining room:', error);
                alert('An error occured while joining a room.');
            }
        }

        // Extract key from encrypted message and join
        async function extractKeyAndJoin() {
            const encryptedText = document.getElementById('encryptedMessage').value.trim();
            
            if (!encryptedText) {
                alert('Please enter encrypted message');
                return;
            }
            
            try {
                const response = await fetch('/api/extract-secret-key', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        invitation_text: encryptedText
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    currentSecretKey = data.secret_key;
                    setupAsReceiver();
                } else {
                    alert('Secret key could not be extracted: ' + data.message);
                }
            } catch (error) {
                console.error('Error extracting key:', error);
                alert('An error occured while extracting key');
            }
        }

        // Extract key from image and join
        async function extractKeyFromImageAndJoin() {
            const imageInput = document.getElementById('stegoImageUpload');
            
            if (!imageInput.files || imageInput.files.length === 0) {
                alert('Please choose image');
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('image', imageInput.files[0]);
                
                // Show loading
                document.getElementById('image-tab').innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
                
                const response = await fetch('/api/extract-key-from-image', {
                    method: 'POST',
                    body: formData
                });
                
                // Reset loading
                document.getElementById('image-tab').textContent = 'Upload Image';
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    currentSecretKey = data.secret_key;
                    setupAsReceiver();
                } else {
                    alert('Secret key could not be extracted: ' + data.message);
                }
            } catch (error) {
                // Reset loading
                document.getElementById('image-tab').textContent = 'Upload Image';
                console.error('Error extracting key from image:', error);
                alert('An error occured during secret key extraction.');
            }
        }

        // Continue as sender after creating a room
        function continueAsSender() {
            setupAsSender();
        }

        // Download steganographic image
        function downloadStegoImage() {
            if (stegoImageFilename) {
                window.open(`/api/download-stego-image/${stegoImageFilename}`, '_blank');
            }
        }

        // Setup as sender
        function setupAsSender() {
            currentRole = 'sender';
            
            // Hide room creation views
            document.getElementById('roomCreatedDirect').style.display = 'none';
            document.getElementById('roomCreatedStego').style.display = 'none';
            document.getElementById('roomCreatedImage').style.display = 'none';
            document.getElementById('roomCreatedEmail').style.display = 'none';
            
            // Show file transfer interface with sender options
            document.getElementById('fileTransfer').style.display = 'block';
            document.getElementById('senderInterface').style.display = 'block';
            document.getElementById('receiverInterface').style.display = 'none';
            
            // Connect WebSocket
            connectWebSocket('sender');
        }

        // Setup as receiver
        function setupAsReceiver() {
            currentRole = 'receiver';
            
            // Hide join room view
            document.getElementById('joinRoomOptions').style.display = 'none';
            
            // Show file transfer interface with receiver options
            document.getElementById('fileTransfer').style.display = 'block';
            document.getElementById('senderInterface').style.display = 'none';
            document.getElementById('receiverInterface').style.display = 'block';
            
            // Connect WebSocket
            connectWebSocket('receiver');
        }

        // Connect to WebSocket
        function connectWebSocket(role) {
            if (wsConnection) {
                wsConnection.close();
            }
            
            const connectionStatus = document.getElementById('connectionStatus');
            connectionStatus.textContent = 'Connecting...';
            
            // Create WebSocket connection
            wsConnection = new WebSocket(`ws://${window.location.host}/ws/${role}/${currentSecretKey}`);
            
            wsConnection.onopen = () => {
                connectionStatus.textContent = 'Connected';
                addLogEntry('Connected to server', 'info');
                
                if (role === 'sender') {
                    checkFileInputState();
                }
            };
            
            wsConnection.onclose = (event) => {
                connectionStatus.textContent = 'Connection lost';
                
                // Check if this was an abnormal closure with a reason
                if (event.code === 1000) {
                    // Normal closure
                    addLogEntry('Connection to server lost', 'info');
                } else {
                    // Abnormal closure
                    addLogEntry('Connection to server lost: ' + (event.reason || 'Bilinmeyen hata'), 'error');
                }
                
                if (role === 'sender') {
                    document.getElementById('sendFileBtn').disabled = true;
                }
            };
            
            wsConnection.onerror = (error) => {
                console.error('WebSocket error:', error);
                connectionStatus.textContent = 'Connnection error';
                addLogEntry('Connnection error', 'error');
            };
            
            wsConnection.onmessage = handleWebSocketMessage;
        }

        // Handle WebSocket messages
        function handleWebSocketMessage(event) {
            try {
                if (typeof event.data === 'string') {
                    const data = JSON.parse(event.data);
                    
                    switch (data.type) {
                        case 'status':
                            updateRoomStatus(data);
                            break;
                        case 'transfer_start':
                            handleTransferStart(data);
                            break;
                        case 'transfer_progress':
                            updateTransferProgress(data);
                            break;
                        case 'transfer_complete':
                            handleTransferComplete(data);
                            break;
                        case 'error':
                            handleErrorMessage(data);
                            break;
                    }
                } else if (currentRole === 'receiver') {
                    // Binary data - we now get a complete file at once, not chunks
                    receivedFileBlob = new Blob([event.data]);
                    addLogEntry('File received, processing...', 'info');
                }
            } catch (error) {
                console.error('Error processing WebSocket message:', error);
            }
        }
        
        // Handle error messages from the server
        function handleErrorMessage(data) {
            // Log error
            addLogEntry(`Error: ${data.message}`, 'error');
            
            // Display the error using our new error display function
            displayErrorMessage(data.message);
            
            // If it's a room capacity error, go back to the join screen
            if (data.message.includes("maximum capacity")) {
                setTimeout(() => {
                    // Disconnect websocket
                    if (wsConnection) {
                        wsConnection.close();
                        wsConnection = null;
                    }
                    
                    // If we're in receiver mode, go back to join options
                    if (currentRole === 'receiver') {
                        document.getElementById('fileTransfer').style.display = 'none';
                        document.getElementById('joinRoomOptions').style.display = 'block';
                    }
                }, 1000);
            }
        }

        // Update room status based on WebSocket message
        function updateRoomStatus(data) {
            document.getElementById('senderCount').textContent = data.senders;
            document.getElementById('receiverCount').textContent = data.receivers;
            
            if (currentRole === 'sender') {
                document.getElementById('sendFileBtn').disabled = !data.ready_to_transfer;
                
                if (data.ready_to_transfer) {
                    addLogEntry('Receiver ready, you may send a file', 'info');
                } else if (data.receivers === 0) {
                    addLogEntry('Waiting for receiver connection', 'info');
                }
            }
        }

        // Handle the start of a file transfer
        function handleTransferStart(data) {
            document.getElementById('transferProgress').style.display = 'block';
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressBar').textContent = '0%';
            
            if (currentRole === 'receiver') {
                // Reset variables
                receivedFileBlob = null;
                encryptionMetadata = null;
                receivedFileName = data.filename;
                
                document.getElementById('fileInfo').textContent = 
                    `Receiving file: ${data.filename} (${formatFileSize(data.filesize)})`;
                
                addLogEntry(`File transfer started: ${data.filename}`, 'info');
                
                // Show encryption information if available
                if (data.encryptionOptions) {
                    document.getElementById('encryptionInfo').style.display = 'block';
                    
                    let methodText = 'Encryption: ';
                    if (data.encryptionOptions.method === 'aes-256-gcm') {
                        methodText += 'AES-256-GCM';
                        addLogEntry('File is encrypted with AES-256-GCM', 'info');
                    } else {
                        methodText += 'No Encryption';
                        addLogEntry('File sending without encryption', 'info');
                    }
                    document.getElementById('encryptionMethodInfo').textContent = methodText;
                    
                    let integrityText = 'Integrity Validation: ';
                    if (data.encryptionOptions.integrityCheck) {
                        integrityText += 'Active (SHA-256)';
                        addLogEntry('SHA-256 integrity validation active', 'info');
                    } else {
                        integrityText += 'Passive';
                        addLogEntry('Integrity validation inactive', 'warning');
                    }
                    document.getElementById('integrityCheckInfo').textContent = integrityText;
                }
            } else {
                document.getElementById('fileInfo').textContent = 
                    `Sending file: ${data.filename} (${formatFileSize(data.filesize)})`;
                
                addLogEntry(`File transfer started: ${data.filename}`, 'info');
            }
        }

        // Update transfer progress
        function updateTransferProgress(data) {
            const percentage = data.percentage;
            document.getElementById('progressBar').style.width = `${percentage}%`;
            document.getElementById('progressBar').textContent = `${percentage}%`;
            
            // Store encryption metadata for decryption
            if (currentRole === 'receiver' && data.encryption_metadata) {
                encryptionMetadata = data.encryption_metadata;
                
                if (data.encryption_metadata.aes_key) {
                    addLogEntry('Keys received', 'info');
                }
                
                if (data.encryption_metadata.file_hash) {
                    addLogEntry('Hash value received', 'info');
                }
            }
        }

        // Handle completed transfer
        function handleTransferComplete(data) {
            addLogEntry('File transfer successful', 'success');
            
            if (currentRole === 'receiver') {
                receivedFileName = data.filename;
                
                // Process the received file if it's encrypted
                if (encryptionMetadata && encryptionMetadata.aes_key) {
                    processEncryptedFile();
                } else {
                    // If not encrypted, show the download button
                    document.getElementById('downloadBtnContainer').style.display = 'block';
                }
                
                // Show integrity verification result if available
                if (data.integrity_verified !== undefined) {
                    const resultElement = document.getElementById('integrityResult');
                    const messageElement = document.getElementById('integrityMessage');
                    
                    resultElement.style.display = 'block';
                    
                    if (data.integrity_verified) {
                        resultElement.className = 'integrity-result integrity-success';
                        messageElement.innerHTML = '<i class="bi bi-check-circle-fill"></i> Integrity validated, you may download the file.';
                        addLogEntry('Integrity validated', 'success');
                    } else {
                        resultElement.className = 'integrity-result integrity-error';
                        messageElement.innerHTML = '<i class="bi bi-exclamation-triangle-fill"></i> WARNING: Integrity validation failed! File may be tampered with.';
                        addLogEntry('Integrity validation failed!', 'error');
                    }
                }
            }
        }

        // Process encrypted file (decryption)
        async function processEncryptedFile() {
            if (!receivedFileBlob || !encryptionMetadata) {
                addLogEntry('File could not be processed: Missing data', 'error');
                return;
            }
            
            try {
                addLogEntry('Decrypting file...', 'info');
                
                // Read file as ArrayBuffer
                const fileData = await receivedFileBlob.arrayBuffer();
                
                // Get encryption parameters
                const aesKeyHex = encryptionMetadata.aes_key;
                const ivHex = encryptionMetadata.iv;
                const tagHex = encryptionMetadata.tag;
                
                // Convert hex strings to Uint8Array
                const aesKey = hexToUint8Array(aesKeyHex);
                const iv = hexToUint8Array(ivHex);
                const tag = hexToUint8Array(tagHex);
                
                // Decrypt the file using WebCrypto API
                const decryptedData = await decryptFileWithAES(fileData, aesKey, iv, tag);
                
                // Create a blob from decrypted data
                receivedFileBlob = new Blob([decryptedData]);
                
                addLogEntry('Decryption successful!', 'success');
                
                // Show download button
                document.getElementById('downloadBtnContainer').style.display = 'block';
            } catch (error) {
                console.error('Decryption error:', error);
                addLogEntry('Error with decryption: ' + error.message, 'error');
            }
        }

        // Helper function to convert hex string to Uint8Array
        function hexToUint8Array(hexString) {
            const bytes = new Uint8Array(hexString.length / 2);
            for (let i = 0; i < hexString.length; i += 2) {
                bytes[i / 2] = parseInt(hexString.substr(i, 2), 16);
            }
            return bytes;
        }

        // Decrypt file with AES-GCM using WebCrypto API
        async function decryptFileWithAES(encryptedData, aesKey, iv, tag) {
            try {
                // Import the AES key
                const key = await window.crypto.subtle.importKey(
                    "raw",
                    aesKey,
                    { name: "AES-GCM" },
                    false,
                    ["decrypt"]
                );
                
                // In AES-GCM, the tag is usually appended to the end of the ciphertext
                // Create a new ArrayBuffer that combines the encryptedData and tag
                const combinedLength = encryptedData.byteLength + tag.byteLength;
                const combinedData = new Uint8Array(combinedLength);
                
                // Copy encrypted data first
                combinedData.set(new Uint8Array(encryptedData), 0);
                // Append the tag
                combinedData.set(tag, encryptedData.byteLength);
                
                // Decrypt the data
                const algorithm = {
                    name: "AES-GCM",
                    iv: iv,
                    tagLength: 128 // 16 bytes (128 bits)
                };
                
                try {
                    const decrypted = await window.crypto.subtle.decrypt(
                        algorithm,
                        key,
                        combinedData
                    );
                    return decrypted;
                } catch (innerError) {
                    console.error("First approach failed, trying alternate approach:", innerError);
                    
                    // Alternate approach - some implementations expect the tag separate from data
                    // Try with just the encrypted data without the tag
                    return await window.crypto.subtle.decrypt(
                        algorithm,
                        key,
                        encryptedData
                    );
                }
            } catch (error) {
                console.error("Decryption error:", error);
                throw new Error("Decryption failed: " + error.message);
            }
        }

        // Format file size for display
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' bytes';
            else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            else if (bytes < 1073741824) return (bytes / 1048576).toFixed(1) + ' MB';
            else return (bytes / 1073741824).toFixed(1) + ' GB';
        }

        // Handle file input changes
        document.getElementById('fileInput').addEventListener('change', function(e) {
            selectedFile = e.target.files[0];
            checkFileInputState();
        });

        // Check if send button should be enabled
        function checkFileInputState() {
            const sendBtn = document.getElementById('sendFileBtn');
            
            if (selectedFile && wsConnection && wsConnection.readyState === WebSocket.OPEN) {
                const receiverCount = parseInt(document.getElementById('receiverCount').textContent);
                
                if (receiverCount > 0) {
                    sendBtn.disabled = false;
                    return;
                }
            }
            
            sendBtn.disabled = true;
        }

        // Send file through WebSocket
        function sendFile() {
            if (!selectedFile || !wsConnection || wsConnection.readyState !== WebSocket.OPEN) {
                alert('File not selected or connection could not be established');
                return;
            }

            // Get encryption options
            const encryptionOptions = {
                method: document.getElementById('encryptionMethod').value,
                integrityCheck: document.getElementById('integrityCheck').checked
            };

            // Show progress UI
            document.getElementById('transferProgress').style.display = 'block';
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressBar').textContent = '0%';
            
            addLogEntry('Starting file transfer...', 'info');
            
            // Log encryption options
            if (encryptionOptions.method === 'aes-256-gcm') {
                addLogEntry('Dosya AES-256-GCM ile ifrelenecek', 'info');
            } else {
                addLogEntry('Dosya ifrelemesiz gnderilecek', 'info');
            }
            
            if (encryptionOptions.integrityCheck) {
                addLogEntry('SHA-256 btnlk dorulamas aktif', 'info');
            }

            // Send file metadata
            wsConnection.send(JSON.stringify({
                type: 'start_transfer',
                filename: selectedFile.name,
                filesize: selectedFile.size,
                encryptionOptions: encryptionOptions
            }));

            // Start reading and sending file chunks
            const chunkSize = 64 * 1024; // 64KB chunks
            const totalChunks = Math.ceil(selectedFile.size / chunkSize);
            let chunkId = 0;

            const reader = new FileReader();
            
            reader.onload = (e) => {
                if (wsConnection.readyState === WebSocket.OPEN) {
                    // Send binary chunk
                    wsConnection.send(e.target.result);
                    
                    // Send chunk metadata
                    wsConnection.send(JSON.stringify({
                        chunk_id: chunkId,
                        total_chunks: totalChunks
                    }));
                    
                    if (chunkId === 0) {
                        addLogEntry('lk dosya paras gnderildi', 'info');
                    } else if (chunkId === totalChunks - 1) {
                        addLogEntry('Son dosya paras gnderildi', 'info');
                    }
                    
                    chunkId++;
                    
                    if (chunkId < totalChunks) {
                        // Read next chunk
                        const start = chunkId * chunkSize;
                        const end = Math.min(start + chunkSize, selectedFile.size);
                        readNextChunk(start, end);
                    }
                }
            };
            
            const readNextChunk = (start, end) => {
                const slice = selectedFile.slice(start, end);
                reader.readAsArrayBuffer(slice);
            };
            
            // Start reading first chunk
            readNextChunk(0, chunkSize);
        }

        // Download received file
        function downloadFile() {
            if (!receivedFileBlob || !receivedFileName) {
                addLogEntry('ndirilecek dosya bulunamad', 'error');
                return;
            }

            const url = URL.createObjectURL(receivedFileBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = receivedFileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            addLogEntry(`Dosya "${receivedFileName}" olarak indirildi`, 'success');
        }

        // Leave room function
        function leaveRoom() {
            if (wsConnection) {
                wsConnection.close();
                wsConnection = null;
            }
            
            // Reset variables
            currentSecretKey = null;
            currentRole = null;
            selectedFile = null;
            receivedFileBlob = null;
            receivedFileName = null;
            receivedChunks = [];
            
            // Reset UI elements
            document.getElementById('transferLogs').innerHTML = '';
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressBar').textContent = '0%';
            document.getElementById('transferProgress').style.display = 'none';
            document.getElementById('integrityResult').style.display = 'none';
            document.getElementById('downloadBtnContainer').style.display = 'none';
            document.getElementById('encryptionInfo').style.display = 'none';
            
            // Go back to initial view
            goBack();
        }

        // Add log entry
        function addLogEntry(message, type = 'info') {
            const logContainer = document.getElementById('transferLogs');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            
            // Add timestamp
            const now = new Date();
            const timestamp = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
            
            entry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(entry);
            
            // Scroll to bottom
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Copy content to clipboard
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            
            if (element.tagName === 'TEXTAREA') {
                navigator.clipboard.writeText(element.value)
                    .then(() => {
                        alert('Text copied to clipboard!');
                    })
                    .catch(err => {
                        console.error('Copy error:', err);
                        alert('Copying failed.');
                    });
            } else {
                navigator.clipboard.writeText(element.textContent)
                    .then(() => {
                        alert('Text copied to clipboard!');
                    })
                    .catch(err => {
                        console.error('Copying failed.:', err);
                        alert('Copying failed..');
                    });
            }
        }

        // Regenerate steganographic text
        async function regenerateStegoText() {
            if (!currentSecretKey) {
                alert('Secret key not available');
                return;
            }
            
            // Show loading indicator
            document.getElementById('regeneratingIndicator').classList.add('show');
            document.getElementById('regenerateBtn').disabled = true;
            
            try {
                // Get regeneration parameters
                const prompt = document.getElementById('regeneratePrompt').value.trim();
                const model = document.getElementById('regenerateModel').value;
                
                // Call API to regenerate text
                const response = await fetch('/api/regenerate-steganographic-text', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        secret_key: currentSecretKey,
                        prompt: prompt || undefined,
                        model: model
                    })
                });
                
                const data = await response.json();
                
                // Hide loading indicator
                document.getElementById('regeneratingIndicator').classList.remove('show');
                document.getElementById('regenerateBtn').disabled = false;
                
                if (data.status === 'success') {
                    // Update the displayed text
                    document.getElementById('stegoMessage').value = data.invitation_text;
                    alert('Text successfully recreated!');
                } else {
                    alert('Text could not be recreated: ' + data.message);
                }
            } catch (error) {
                console.error('Error regenerating text:', error);
                document.getElementById('regeneratingIndicator').classList.remove('show');
                document.getElementById('regenerateBtn').disabled = false;
                alert('An error occured during text recreation.');
            }
        }

        // Load available models from API when page loads
        async function loadAvailableModels() {
            try {
                const response = await fetch('/api/get-available-models');
                const data = await response.json();
                
                if (data.status === 'success' && data.models) {
                    // Populate model select dropdowns
                    const modelSelect = document.getElementById('modelSelect');
                    const regenerateModel = document.getElementById('regenerateModel');
                    
                    // Clear existing options
                    modelSelect.innerHTML = '';
                    regenerateModel.innerHTML = '';
                    
                    // Add models to dropdowns
                    Object.entries(data.models).forEach(([id, name]) => {
                        const option1 = new Option(name, id);
                        const option2 = new Option(name, id);
                        
                        modelSelect.appendChild(option1);
                        regenerateModel.appendChild(option2);
                    });
                }
            } catch (error) {
                console.error('Error loading available models:', error);
            }
        }

        // Display a styled error message
        function displayErrorMessage(message) {
            // Create an error alert if it doesn't exist yet
            let errorAlert = document.getElementById('errorAlert');
            if (!errorAlert) {
                errorAlert = document.createElement('div');
                errorAlert.id = 'errorAlert';
                errorAlert.className = 'alert alert-danger alert-dismissible fade show';
                errorAlert.innerHTML = `
                    <strong><i class="bi bi-exclamation-triangle-fill"></i> Hata!</strong> 
                    <span id="errorMessage"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                
                // Insert the error alert at the top of the current view
                const currentView = document.querySelector('.card[style*="display: block"]');
                if (currentView) {
                    currentView.querySelector('.card-body').prepend(errorAlert);
                } else {
                    // Fallback - add to body
                    document.body.prepend(errorAlert);
                }
            }
            
            // Set the error message
            document.getElementById('errorMessage').textContent = message;
            
            // Automatically hide after 5 seconds
            setTimeout(() => {
                const bsAlert = new bootstrap.Alert(errorAlert);
                bsAlert.close();
            }, 5000);
        }

        // Call loadAvailableModels on page load
        document.addEventListener('DOMContentLoaded', loadAvailableModels);

        // Theme toggle functionality
        document.getElementById('themeToggle').addEventListener('click', function() {
            const currentTheme = document.body.getAttribute('data-bs-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.body.setAttribute('data-bs-theme', newTheme);
            this.querySelector('i').className = newTheme === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-fill';
        });
    </script>
</body>
</html>
